### Tools: Tldr

- I would use
  - `kubectl` for k8s admin tasks
  - `nerdctl` for general container tasks, with usage typically like by replacing Docker commands' `docker` with `nerdctl`
  - `crictl`: (not much used) main usage is debuging container runtime

# kubectl

- [kubectl cheatsheet](https://kubernetes.io/docs/reference/kubectl/cheatsheet/)

- alias

```bash
alias k='kubectl'
alias h='history'
alias kd='kubectl describe'
# Create a YAML template:
alias krdr="kubectl run --dry-run=client -o yaml"
alias kcddr="kubectl create deployment --dry-run=client -o yaml"


## Other
export EDITOR=vim
echo 'set number' >> .vimrc
alias lm='ls -al'
alias h='history'

# TODO
# alias ke='kubectl edit'
# alias kdd='kubectl delete'
# alias kns='kubens'
# alias kcx='kubectx'
# alias wkgp='watch kubectl get pod'
```

### handy basic commands

- resource management:

  - Imperative: single purposed command, return an error if command fail
    - run, create, patch, replace, expose, edit, scale, set image...
  - Declarative: (preferred: easier to track) apply yaml requirement, adjust resource to the declared state
    - `apply`

- create resource

```bash
# create resource directly from image

k run nginx --image=nginx
k create deployment --image=nginx nginx


# generate a template to a yaml file
k run nginx --image=nginx --dry-run=client -o yaml > ngx.yaml  # generate a pod
k create deployment nginx-deployment --image=nginx --replicas=4 --dry-run=client -o yaml > ngx-deploy.yaml  # generate a deployment
k expose pod redis --name=redis-service --type=clusterip --port=6379 --target-port=6379 --dry-run=client -o yaml > redis-service.yml     # generate a service

# edit a yaml
k edit pod resource-name  # edit a resource yml with editor,
                          # :sav output.yaml

# Create from file: declarative and Imperative
k apply -f webapp.yaml          # apply a config file
k apply -f /path/to/configs     # apply all config file in a directory
k create -f ngx.yaml
```

- get resource info

```bash
## Listing
k get all
k get <resource> -o wide  # extended info
k get pods --selector='elasticsearch.k8s.elastic.co/cluster-name=quickstart'


## Describe
  # What is the Image/Label/IP used to create the nginx?
  # Why do you think the deployment is not ready?
k describe svc {svc-name}
k describe pod {pod-name}
```

- delete resource

```bash
k delete pod <pod-name>
k delete pods,services -l <labelName> # Delete pods and services that matches labelName
k delete -f nginx.yml                 # delete resource create from file

```

## List of Common Commands

- syntax:

```bash
kubectl <command> <resource-type> <resource-name> <flags>
kubectl --help  # get help
```

- commands

```bash
# basic
apply         # Declarative create/update
run           # run a image as a pod
create        # imperative create resource
edit          # edit a resource yml with editor, (:sav output.yaml)
delete        # delete a resource

# info
get           # get info of resource
describe      # describe resource

# imperative update
patch         # update a field in a resource
label         # update label of a resource
set image     # set feature of a resource: eg image


# service
expose        # expose a resource as service

# pod/container management
logs          # output logs in pod
attach        # enter a container
exec          # execute a command in container
cp            # cp files from/to container

# Deployment/ replicasSet
rollout
scale --replicas   # manually scale to deployment or replicasSet
autoscale     # auto scale to deployment or replicasSet

# Cluster
cluster-info  # Display cluster information
top           # Display resource (CPU/memory) usage
version       # cluster version
```

- resource-types: nodes, service(svc), replicaset(rs), pod, deployment(deploy), namespace(ns), ingresses(ing), configmaps(cm)...

```bash
k api-resources # list all resource
```

- flags

```bash
# behavior
--dry-run=client  # command will not execute (think syntax compile)
-o yaml     # display in yaml
-o wide     # display more details
--selector  # filter resources based on their labels.
--namespace # specify the namespace a command to be executed


# info
-f          # path to a file
--image     # specify image name
--replicas  # specify number of replicas

# service
--type            # type of service
--target-port     # target-port
--node-port       # node-port
--port            # port of container

# namespace
--namespace=dev   # -n: run in another namespace
--all-namespaces  # apply to all namespace
```

### Imperative

```bash
# Imperative world in k8s
  # Create Object
k run
k create deployment
k create -f webapp.yaml  # create a new resource, return an error if resource exist
k expose deployment webapp --port 3000
  # Update Object
k edit deployment webapp
k replace -f webapp.yaml  # return an error if resource not-exist
k scale deployment webapp --replicas=5
k set image deployment webapp nginx=nginx:1.18
k delete -f webapp.yaml
```

### Service

```bash
k expose pod httpd --type=clusterip --name=httpd --port=80 --target-port=80
kubectl create service nodeport nginx --tcp=80:80 --node-port=30080 --dry-run=client -o yaml
```

### Namespace

```bash
# create namespace
k create namespace dev

# get namespace
k get ns

# run command in other namespace (Temporarily)
k apply -f webapp.yaml --namespace=dev

# Switch context namespace
k config set-context $(kubectl config current-context) --namespace=dev

# get resource in all namespaces
k get pod --all-namespaces
```

### replicaSets

```bash
# update replicas number
k replace -f replicaset-def.yaml   # edit config file and update with updated file
k scale --replicas=6 -f replicaset-def.yaml     # inline update. `replicas: number` will not change within the file
k scale --replicas=6 replicaset replicaset-name
```

- TODO

```bash
## get application logs

kubectl logs {pod-name}

# List information about a resource with more details:

kubectl get pod|service|deployment|ingress|... -o wide

# Update specified pod with the label 'unhealthy' and the value 'true':

kubectl label pods name unhealthy=true

# List all resources with different types:

kubectl get all

# Display resource (CPU/Memory/Storage) usage of nodes or pods:

kubectl top pod|node

# Print the address of the master and cluster services:

kubectl cluster-info

# Display an explanation of a specific field:

kubectl explain pods.spec.containers

# Print the logs for a container in a pod or specified resource:

kubectl logs pod_name

# Run command in an existing pod:

kubectl exec pod_name -- ls /

```
