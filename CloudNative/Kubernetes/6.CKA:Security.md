# ApiServer Access Control

- [User Authentication: TLS cert](https://kubernetes.io/docs/reference/access-authn-authz/certificate-signing-requests/#normal-user)
- [User Authentication: Token](https://kubernetes.io/docs/reference/access-authn-authz/bootstrap-tokens/)
- [Service Account](https://kubernetes.io/docs/concepts/security/service-accounts/)
- [RBAC](https://kubernetes.io/docs/reference/access-authn-authz/rbac/)
- [Admission Controllers](https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/)

- ApiServer access control process:

  - user request ->
  - Authentication (who you are) ->
  - Authorization (what you can do) ->
  - Admission Control (provide last-minute access control) ->
  - apiServer approve and fulfill request

- k8s identities: User & ServiceAccount

  - `User`: provide id for human user (admins, developers...).
    - User is not a resource in k8s!
    - User is identified through external reference (HTTP token, HTTPs cert...)
  - `ServiceAccount`: provide id for application process running inside pod (eg. jenkins).
    - `serviceaccounts (sa)` is a first-class resource in k8s

- User Authentication:

  - `Password Based(deprecated)`: provide base64 encoded username/password in header
  - `Bootstrap Tokens`: provide token in HTTP Header
  - `HTTPS cert(recommend)`: provide ca cert
  - third-party Auth services

- Authorization (define who can do what)

  - AlwaysAllow: `K8s default`
  - RBAC (Role-Based Access Control): `kubeadm installed k8s default`
  - other: AlwaysDeny, ABAC, Node, Webhook

## Authentication: TLS

- [bili](https://www.bilibili.com/video/BV1Qv41167ck?p=82)

## Authorization: RBAC (Role-Based Access Control)

- RBAC:

  - Identities: User Account/ Service Account/ Group
  - Role: a collection of operation over some resource (permission template: a role is able to do xxx)
  - Binding: bind a role to a Identity

- RBAC identities

  - User: provide id for human user (admins, developers...).
  - ServiceAccount: provide id for application process running inside pod (eg. jenkins).
  - `Group`: a group of User Account or Service Account

- RBAC resources
  - `Role, ClusterRole`: define Roles (in a namespace/ global)
  - `RoleBinding, ClusterRoleBinding`: define Identity to Role binding (in a namespace/ global)

```yml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  namespace: dev
  name: dev-role
rules:
  - apiGroups: [""] # "" means core apiGroup
    resources: ["pods", "services", "configmaps"]
    verbs: ["get", "list", "watch", "create", "update", "delete"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: dev-role-binding
  namespace: dev
subjects:
  - kind: ServiceAccount
    name: <service-account-name>
    namespace: <namespace>
  - kind: User
    name: Aqua
    apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: Role
  name: dev-role
  apiGroup: rbac.authorization.k8s.io
--- # RoleBinding can also bind an Indentity to a ClusterRole
roleRef:
  kind: ClusterRole
  name: cluster-role
  apiGroup: rbac.authorization.k8s.io
```

# TLS Certification for In-Cluster Communication

# Network Policies: Restrict Inter-pod Communication
